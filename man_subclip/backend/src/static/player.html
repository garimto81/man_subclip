<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS Video Player - Test</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .video-container {
            background: #000;
            border-radius: 4px;
            margin-bottom: 20px;
            position: relative;
        }
        video {
            width: 100%;
            max-width: 100%;
            border-radius: 4px;
            display: block;
        }
        .controls {
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        .presets {
            margin-bottom: 20px;
        }
        .preset-button {
            background: #28a745;
            margin-right: 10px;
            margin-bottom: 10px;
            padding: 8px 16px;
            font-size: 14px;
        }
        .preset-button:hover {
            background: #218838;
        }
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #007bff;
        }
        .info-box code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .timeline-editor {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .timeline-editor h3 {
            margin-top: 0;
            color: #333;
        }
        .timecode-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .timecode-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .timecode-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }
        .timecode-input {
            width: 150px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .duration-display {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            padding: 8px;
        }
        .control-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .control-btn:hover {
            background: #5a6268;
        }
        .play-selection-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }
        .play-selection-btn:hover {
            background: #218838;
        }
        .timeline-container {
            background: white;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
        }
        #timeline {
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .playback-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .playback-controls label {
            font-weight: 600;
            color: #333;
        }
        .playback-controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .download-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }
        .download-btn:hover {
            background: #ee5a52;
        }
        .download-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 4px;
            display: none;
        }
        .download-status.show {
            display: block;
        }
        .download-status.downloading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .download-status.ready {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .download-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .download-link {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 600;
        }
        .download-link:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ HLS Video Player</h1>
        <p class="subtitle">Transcoder APIë¡œ ìƒì„±ëœ HLS ì˜ìƒì„ ë¸Œë¼ìš°ì €ì—ì„œ ì¬ìƒí•©ë‹ˆë‹¤</p>

        <div class="info-box">
            <h3>â„¹ï¸ ì‚¬ìš© ë°©ë²•</h3>
            <p>1. ì•„ë˜ í”„ë¦¬ì…‹ ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜</p>
            <p>2. GCS HLS URLì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</p>
            <p><strong>GCS URL í˜•ì‹:</strong> <code>gs://ë²„í‚·ëª…/ê²½ë¡œ/master.m3u8</code></p>
            <p><strong>HTTP URL í˜•ì‹:</strong> <code>https://storage.googleapis.com/ë²„í‚·ëª…/ê²½ë¡œ/master.m3u8</code></p>
        </div>

        <div class="presets">
            <button class="preset-button" onclick="loadPreset1()">
                ğŸ“¹ Test Video 1 (h_wsop24_ev1_17150020)
            </button>
            <button class="preset-button" onclick="loadPreset2()">
                ğŸ“¹ Test Video 2 (h_wsop24_ev1_sample_03) - 159ì´ˆ
            </button>
            <button class="preset-button" onclick="loadPresetShortClip()" style="background: #ff6b6b;">
                âœ‚ï¸ Short Clip (78~136ì´ˆ êµ¬ê°„, 58ì´ˆ)
            </button>
        </div>

        <div class="controls">
            <div class="input-group">
                <label for="videoUrl">HLS ì˜ìƒ URL (GCS ë˜ëŠ” HTTP):</label>
                <input
                    type="text"
                    id="videoUrl"
                    placeholder="gs://wsop-archive-proxy/wsop24_ev1_part1/master.m3u8"
                    value="gs://wsop-archive-proxy/wsop24_ev1_part1/master.m3u8"
                >
            </div>
            <button onclick="loadVideo()">ğŸ¥ ì˜ìƒ ì¬ìƒ</button>
        </div>

        <div id="status" class="status"></div>

        <div class="video-container">
            <video id="video" controls></video>
        </div>

        <!-- Timeline Editor -->
        <div class="timeline-editor">
            <h3>âœ‚ï¸ êµ¬ê°„ í¸ì§‘</h3>

            <div class="timecode-row">
                <div class="timecode-group">
                    <label>In Point:</label>
                    <input type="text" id="inPoint" placeholder="00:00:00.000" class="timecode-input">
                    <button onclick="setInPoint()" class="control-btn">Set In</button>
                    <button onclick="goToInPoint()" class="control-btn">â†’ In</button>
                </div>
                <div class="timecode-group">
                    <label>Out Point:</label>
                    <input type="text" id="outPoint" placeholder="00:00:00.000" class="timecode-input">
                    <button onclick="setOutPoint()" class="control-btn">Set Out</button>
                    <button onclick="goToOutPoint()" class="control-btn">â†’ Out</button>
                </div>
                <div class="timecode-group">
                    <label>Duration:</label>
                    <span id="selectionDuration" class="duration-display">00:00:00.000</span>
                </div>
            </div>

            <div class="timeline-container">
                <canvas id="timeline" width="1000" height="80"></canvas>
            </div>

            <div class="playback-controls">
                <button onclick="playSelection()" class="play-selection-btn">ğŸ” êµ¬ê°„ ë¯¸ë¦¬ë³´ê¸° (Loop)</button>
                <button onclick="stopSelection()" class="control-btn">â¹ï¸ ì •ì§€</button>
                <button onclick="downloadClip()" class="download-btn">ğŸ’¾ ì„œë¸Œí´ë¦½ ë‹¤ìš´ë¡œë“œ</button>
                <label>ì¬ìƒ ì†ë„:</label>
                <select id="playbackSpeed" onchange="changeSpeed()">
                    <option value="0.5">0.5x</option>
                    <option value="0.75">0.75x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
            </div>

            <div id="downloadStatus" class="download-status"></div>
        </div>

        <div class="info-box">
            <h3>ğŸ“Š í˜„ì¬ ìƒíƒœ</h3>
            <p id="videoInfo">ì˜ìƒì„ ë¡œë“œí•˜ë©´ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const videoUrl = document.getElementById('videoUrl');
        const status = document.getElementById('status');
        const videoInfo = document.getElementById('videoInfo');

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function convertGcsToHttp(url) {
            // gs://bucket/path -> https://storage.googleapis.com/bucket/path
            if (url.startsWith('gs://')) {
                return url.replace('gs://', 'https://storage.googleapis.com/');
            }
            return url;
        }

        function loadPreset1() {
            videoUrl.value = 'gs://wsop-archive-proxy/wsop24_ev1_part1/master.m3u8';
            loadVideo();
        }

        function loadPreset2() {
            videoUrl.value = 'gs://wsop-archive-proxy/wsop24_ev1_part1/master.m3u8';
            loadVideo();
        }

        function loadPresetShortClip() {
            videoUrl.value = 'gs://wsop-archive-proxy/wsop24_ev1_part1_short/master.m3u8';
            loadVideo();
        }

        function loadVideo() {
            const url = videoUrl.value.trim();
            if (!url) {
                showStatus('âŒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            // GCS URLì„ HTTP URLë¡œ ë³€í™˜
            const httpUrl = convertGcsToHttp(url);

            showStatus(`â³ ì˜ìƒ ë¡œë”© ì¤‘... (${httpUrl})`, 'info');

            if (Hls.isSupported()) {
                let hls = new Hls({
                    debug: false,  // ì½˜ì†” ë¡œê·¸ ì¤„ì´ê¸°
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 30,  // 90ì´ˆ -> 30ì´ˆë¡œ ì¤„ì„
                    maxBufferLength: 30,
                    maxMaxBufferLength: 60,
                    manifestLoadingTimeOut: 10000,
                    manifestLoadingMaxRetry: 4,
                    levelLoadingTimeOut: 10000,
                    levelLoadingMaxRetry: 4,
                    fragLoadingTimeOut: 20000,
                    fragLoadingMaxRetry: 6
                });

                let recoverAttempts = 0;
                const MAX_RECOVER_ATTEMPTS = 3;

                hls.loadSource(httpUrl);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    showStatus('âœ… HLS ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë¡œë“œ ì„±ê³µ! ì¬ìƒ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', 'success');
                    videoInfo.innerHTML = `
                        <strong>ì˜ìƒ ì •ë³´:</strong><br>
                        - URL: <code>${httpUrl}</code><br>
                        - Levels: ${data.levels.length}ê°œ<br>
                        - í•´ìƒë„: ${data.levels.map(l => `${l.width}x${l.height}`).join(', ')}<br>
                        - ë¹„íŠ¸ë ˆì´íŠ¸: ${data.levels.map(l => `${(l.bitrate / 1000000).toFixed(2)} Mbps`).join(', ')}
                    `;

                    // ìë™ ì¬ìƒ ì‹œë„
                    video.play().catch(e => {
                        console.log('ìë™ ì¬ìƒ ë¶ˆê°€ (ì‚¬ìš©ì ì¸í„°ë™ì…˜ í•„ìš”):', e);
                    });
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS Error:', data);

                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                showStatus(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${data.details}`, 'error');
                                console.error('Network error details:', data);

                                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë³µêµ¬ ì‹œë„
                                if (recoverAttempts < MAX_RECOVER_ATTEMPTS) {
                                    recoverAttempts++;
                                    showStatus(`â³ ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ì‹œë„ ì¤‘... (${recoverAttempts}/${MAX_RECOVER_ATTEMPTS})`, 'info');
                                    hls.startLoad();
                                } else {
                                    showStatus('âŒ ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.', 'error');
                                }
                                break;

                            case Hls.ErrorTypes.MEDIA_ERROR:
                                showStatus(`âŒ ë¯¸ë””ì–´ ì˜¤ë¥˜: ${data.details}`, 'error');
                                console.error('Media error details:', data);

                                // ë¯¸ë””ì–´ ì˜¤ë¥˜ ë³µêµ¬ ì‹œë„
                                if (recoverAttempts < MAX_RECOVER_ATTEMPTS) {
                                    recoverAttempts++;
                                    showStatus(`â³ ë¯¸ë””ì–´ ë³µêµ¬ ì‹œë„ ì¤‘... (${recoverAttempts}/${MAX_RECOVER_ATTEMPTS})`, 'info');

                                    try {
                                        hls.recoverMediaError();
                                    } catch (e) {
                                        console.error('Recovery failed:', e);
                                        // ì™„ì „íˆ ì¬ì‹œì‘
                                        hls.destroy();
                                        showStatus('â³ í”Œë ˆì´ì–´ ì¬ì‹œì‘ ì¤‘...', 'info');
                                        setTimeout(() => {
                                            loadVideo();
                                        }, 1000);
                                    }
                                } else {
                                    showStatus('âŒ ë¯¸ë””ì–´ ë³µêµ¬ ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.', 'error');
                                    hls.destroy();
                                }
                                break;

                            default:
                                showStatus(`âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: ${data.details}`, 'error');
                                console.error('Fatal error:', data);
                                hls.destroy();
                                break;
                        }
                    } else {
                        // Non-fatal errors (ê²½ê³ ë§Œ í‘œì‹œ)
                        console.warn('HLS non-fatal error:', data);
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari native HLS support
                video.src = httpUrl;
                video.addEventListener('loadedmetadata', function() {
                    showStatus('âœ… ì˜ìƒ ë¡œë“œ ì„±ê³µ! (Safari Native HLS)', 'success');
                    videoInfo.innerHTML = `
                        <strong>ì˜ìƒ ì •ë³´:</strong><br>
                        - URL: <code>${httpUrl}</code><br>
                        - ì¬ìƒ ì‹œê°„: ${video.duration.toFixed(2)}ì´ˆ<br>
                        - Safari Native HLS ì§€ì›
                    `;
                    video.play().catch(e => {
                        console.log('ìë™ ì¬ìƒ ë¶ˆê°€:', e);
                    });
                });
                video.addEventListener('error', function(e) {
                    showStatus(`âŒ ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
                });
            } else {
                showStatus('âŒ ë¸Œë¼ìš°ì €ê°€ HLSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
            }
        }

        // ===== Timeline Editor Functions =====

        let inPoint = 0;  // In marker time (seconds)
        let outPoint = 0; // Out marker time (seconds)
        let isLooping = false;
        const canvas = document.getElementById('timeline');
        const ctx = canvas ? canvas.getContext('2d') : null;

        // Timecode conversion: seconds -> HH:MM:SS.mmm
        function secondsToTimecode(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;
        }

        // Timecode conversion: HH:MM:SS.mmm -> seconds
        function timecodeToSeconds(timecode) {
            const parts = timecode.split(':');
            if (parts.length !== 3) return 0;

            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            const secondsAndMs = parts[2].split('.');
            const seconds = parseInt(secondsAndMs[0]) || 0;
            const ms = parseInt(secondsAndMs[1]) || 0;

            return hours * 3600 + minutes * 60 + seconds + ms / 1000;
        }

        // Set In Point at current time
        function setInPoint() {
            if (!video.duration) {
                showStatus('âŒ ì˜ìƒì„ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”', 'error');
                return;
            }
            inPoint = video.currentTime;
            document.getElementById('inPoint').value = secondsToTimecode(inPoint);
            updateDuration();
            drawTimeline();
            showStatus(`âœ… In Point ì„¤ì •: ${secondsToTimecode(inPoint)}`, 'success');
        }

        // Set Out Point at current time
        function setOutPoint() {
            if (!video.duration) {
                showStatus('âŒ ì˜ìƒì„ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”', 'error');
                return;
            }
            outPoint = video.currentTime;
            document.getElementById('outPoint').value = secondsToTimecode(outPoint);
            updateDuration();
            drawTimeline();
            showStatus(`âœ… Out Point ì„¤ì •: ${secondsToTimecode(outPoint)}`, 'success');
        }

        // Go to In Point
        function goToInPoint() {
            if (inPoint > 0) {
                video.currentTime = inPoint;
                showStatus(`â–¶ï¸ In Pointë¡œ ì´ë™: ${secondsToTimecode(inPoint)}`, 'info');
            }
        }

        // Go to Out Point
        function goToOutPoint() {
            if (outPoint > 0) {
                video.currentTime = outPoint;
                showStatus(`â–¶ï¸ Out Pointë¡œ ì´ë™: ${secondsToTimecode(outPoint)}`, 'info');
            }
        }

        // Update selection duration display
        function updateDuration() {
            const duration = outPoint - inPoint;
            const durationDisplay = document.getElementById('selectionDuration');
            if (duration > 0) {
                durationDisplay.textContent = secondsToTimecode(duration);
                durationDisplay.style.color = '#28a745';
            } else {
                durationDisplay.textContent = '00:00:00.000';
                durationDisplay.style.color = '#999';
            }
        }

        // Play selection (loop between In and Out)
        function playSelection() {
            if (inPoint === 0 && outPoint === 0) {
                showStatus('âŒ In/Out Pointë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”', 'error');
                return;
            }
            if (outPoint <= inPoint) {
                showStatus('âŒ Out Pointê°€ In Pointë³´ë‹¤ ë’¤ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤', 'error');
                return;
            }

            isLooping = true;
            video.currentTime = inPoint;
            video.play();
            showStatus(`ğŸ” êµ¬ê°„ ë¯¸ë¦¬ë³´ê¸° ì‹œì‘ (${secondsToTimecode(inPoint)} ~ ${secondsToTimecode(outPoint)})`, 'success');
        }

        // Stop selection playback
        function stopSelection() {
            isLooping = false;
            video.pause();
            showStatus('â¹ï¸ ì¬ìƒ ì •ì§€', 'info');
        }

        // Change playback speed
        function changeSpeed() {
            const speed = parseFloat(document.getElementById('playbackSpeed').value);
            video.playbackRate = speed;
            showStatus(`âš¡ ì¬ìƒ ì†ë„: ${speed}x`, 'info');
        }

        // Draw timeline canvas
        function drawTimeline() {
            if (!ctx || !video.duration) return;

            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Background
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, width, height);

            // Timeline track
            ctx.fillStyle = '#ddd';
            ctx.fillRect(0, height / 2 - 2, width, 4);

            const duration = video.duration;

            // Selection range (In ~ Out)
            if (inPoint > 0 && outPoint > inPoint) {
                const inX = (inPoint / duration) * width;
                const outX = (outPoint / duration) * width;
                ctx.fillStyle = 'rgba(40, 167, 69, 0.3)';
                ctx.fillRect(inX, 0, outX - inX, height);
            }

            // In marker
            if (inPoint > 0) {
                const inX = (inPoint / duration) * width;
                ctx.fillStyle = '#28a745';
                ctx.fillRect(inX - 2, 0, 4, height);
                ctx.fillText('In', inX + 5, 15);
            }

            // Out marker
            if (outPoint > 0) {
                const outX = (outPoint / duration) * width;
                ctx.fillStyle = '#dc3545';
                ctx.fillRect(outX - 2, 0, 4, height);
                ctx.fillText('Out', outX + 5, 15);
            }

            // Current playhead
            const currentX = (video.currentTime / duration) * width;
            ctx.fillStyle = '#007bff';
            ctx.fillRect(currentX - 1, 0, 2, height);
        }

        // Timeline click handler
        if (canvas) {
            canvas.addEventListener('click', function(e) {
                if (!video.duration) return;

                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const percentage = x / canvas.width;
                const time = percentage * video.duration;

                video.currentTime = time;
                showStatus(`â–¶ï¸ ${secondsToTimecode(time)}ë¡œ ì´ë™`, 'info');
            });
        }

        // Video timeupdate event - update playhead and check loop
        video.addEventListener('timeupdate', function() {
            drawTimeline();

            // Loop playback
            if (isLooping && outPoint > 0 && video.currentTime >= outPoint) {
                video.currentTime = inPoint;
            }
        });

        // Video loadedmetadata event - initialize timeline
        video.addEventListener('loadedmetadata', function() {
            // Reset markers
            inPoint = 0;
            outPoint = 0;
            document.getElementById('inPoint').value = '';
            document.getElementById('outPoint').value = '';
            updateDuration();
            drawTimeline();
        });

        // ===== End Timeline Editor Functions =====

        // ===== Download Clip Functions =====

        async function downloadClip() {
            const downloadStatusEl = document.getElementById('downloadStatus');

            // Validation
            if (inPoint === 0 && outPoint === 0) {
                showStatus('âŒ In/Out Pointë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”', 'error');
                return;
            }
            if (outPoint <= inPoint) {
                showStatus('âŒ Out Pointê°€ In Pointë³´ë‹¤ ë’¤ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤', 'error');
                return;
            }

            // Show downloading status
            downloadStatusEl.className = 'download-status show downloading';
            downloadStatusEl.innerHTML = 'â³ ì„œë¸Œí´ë¦½ ìƒì„± ì¤‘...';

            try {
                // Call clips API
                const response = await fetch('/api/clips/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hand_id: 'h_wsop24_ev1_sample_03',  // TODO: Get from current video
                        start_seconds: inPoint,
                        end_seconds: outPoint,
                        padding_seconds: 0
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Show download link
                downloadStatusEl.className = 'download-status show ready';
                downloadStatusEl.innerHTML = `
                    âœ… ì„œë¸Œí´ë¦½ ìƒì„± ì™„ë£Œ!<br>
                    <strong>íŒŒì¼ í¬ê¸°</strong>: ${data.file_size_mb} MB<br>
                    <strong>ì¬ìƒ ì‹œê°„</strong>: ${secondsToTimecode(data.duration_seconds)}<br>
                    <a href="${data.download_url}" class="download-link" download>ğŸ’¾ ë‹¤ìš´ë¡œë“œ</a>
                `;

                showStatus(`âœ… ì„œë¸Œí´ë¦½ ìƒì„± ì™„ë£Œ (${data.clip_id})`, 'success');

            } catch (error) {
                console.error('Download error:', error);
                downloadStatusEl.className = 'download-status show error';
                downloadStatusEl.innerHTML = `âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                showStatus(`âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // ===== End Download Clip Functions =====

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì²« ì˜ìƒ ë¡œë“œ
        window.addEventListener('load', function() {
            showStatus('â„¹ï¸ í”„ë¦¬ì…‹ ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ URLì„ ì…ë ¥í•˜ê³  "ì˜ìƒ ì¬ìƒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', 'info');
        });
    </script>
</body>
</html>
